# 20230722

## ファイルシステム

- ストレージは、いくつかのパーティションという単位に分割される
- 各パーティションには、決められたルールでデータが格納される
- このデータの並びのルールや、そのルールでOSから読み書きできるようにするしくみは、ローカルファイルシステムと呼ばれ、いくつか種類がある

- `df`はシステムが利用してるローカルファイルシステムの一覧を表示するコマンド

```bash
root@3e3e959db293:/# df -Th
# Filesystem       Type       Size  Used Avail Use% Mounted on
# overlay          overlay    184G   31G  144G  18% /
# tmpfs            tmpfs       64M     0   64M   0% /dev
# shm              tmpfs       64M     0   64M   0% /dev/shm
# /host_mark/Users fakeowner  461G  177G  284G  39% /shell
# /dev/vda1        ext4       184G   31G  144G  18% /etc/hosts
# tmpfs            tmpfs      3.9G     0  3.9G   0% /sys/firmware

```

- `df -Th`の後ろにパイプを繋げ、ヘッダの行とディレクトリのルート(/)に関する情報の行を抽出し、情報を読み取る

```bash

root@3e3e959db293:/# df -Th | awk 'NR==1 || $NF=="/"'
# Filesystem       Type       Size  Used Avail Use% Mounted on
# overlay          overlay    184G   31G  144G  18% /

```

- `Filesystem`
  - ファイルシステムの種類
  - パーティションを表す
- `Type`
  - ファイルシステムの種類
  - パーティションのローカルファイルシステムを表す
- `Mounted on`
  - パーティションが、どのディレクトrの下にぶらさがっているかを表す
  - LinuxやUnix系OSは、ストレージをディレクトリツリー(ディレクトリの木構造)内のどこでもぶら下げることができる
  - 複数のパーティションがディレクトリツリーを通じて親子関係になることができる

## iノード

- ローカルファイルシステム内のファイルやディレクトリには、iノード番号(アイノード番号)という、ローカルファイルシステム内での固有の番号が付けられている
- ファイルやディレクトリのiノード番号は、次のように`ls -i`で調査できる

```bash

root@3e3e959db293:/# ls -i
# 7343989 bin   7344931 home   7344948 opt   7344998 sbin   4982850 tmp
# 7343992 boot  7344932 lib          1 proc    17401 shell  5120482 usr
#       1 dev   7344938 media  7344961 root  7345001 srv    5120472 var
# 5120509 etc   7344947 mnt    7344967 run         1 sys

```

- 次のワンライナーで、同じiノード番号をもつディレクトリやファイルが抽出できる

```bash

ls -i / | sort -k 1,1n | awk '{print $2,$1}' | uniq -f 1 -D

```

```bash
root@3e3e959db293:/# ls -i / | sort -k 1,1n | awk '{print $2,$1}' | uniq -f 1 -D
# dev 1
# proc 1
# sys 1

```

### iノードについて

- iノードとは、Unix系のファイルシステムが、ファイルをメモリやストレージ上で管理する時のデータ構造のこと
- ファイルがファイル名ではなく、iノード番号で識別されることを知っていると、ファイル名を変更したり、ファイルを削除したりするときに、どのような処理が行われているかを理解できる

## ls -lの出力の2列目

- hogeというファイルを作ってls -lをする
  - その時出力の2行目の1という数字が100になるようにする
- Unix系のOSで利用されるファイルシステムでは、ファイル(iノード)に対してファイル名を複数つける機能がある
  - この、ファイル名からiノードの対応をリンクという
  - ハードリンクとシンボリックリンクの2種類がある

- ファイルには、作成された時点でハードリンクが1つ割り当てられる
- ls -lで2列目に出力される数は、ハードリンクの数(リンク数)を表す
- lnを使うと、hogeが指しているファイルに対して99個、別の名前でハードリンクが作れる

### iノードとファイル名

- システム内では、ファイルはファイル名ではなく、iノード番号で識別される
- rmの実際は「iノードからのファイル名の切り離し」
