# 20230829

## パケットを使ったOSの推定

- `gyhyo.jp`にpingを送信する
- そのホストのレスポンスからTTLを抽出して動作を出力するワンライナーを考える

```bash

ping -4 gihyo.jp | grep -m 1 -oP 'ttl=\K\d+'
# 62
```

- ICMPパケットが通る通信経路には、宛先のホストだけではなくルータやレイヤ3以上のスイッチが存在する
- ICMPパケットを送って帰ってくるまでに、いくつのノードを経由するか数えて数字を出力する

```bash

root@babd690b7721:/# traceroute -I gihyo.jp
# traceroute to gihyo.jp (172.67.22.15), 30 hops max, 60 byte packets
#  1  172.19.0.1 (172.19.0.1)  2.216 ms  0.058 ms  0.015 ms
#  2  192.168.65.5 (192.168.65.5)  0.182 ms  0.025 ms  0.020 ms
#  3  172.67.22.15 (172.67.22.15)  43.959 ms  44.854 ms  44.814 ms

```

- 1フィールド目の数字は、経由したノードの個数だけ増えていく

```bash
sudo traceroute -I gihyo.jp 2>/dev/null | awk 'END{print $1-1}'
# 2
```

### TTLによるOSの推定

- パケットを返す時のTTLのアタは、OSごとに初期設定値が存在する
  - Linux: 64
  - Windows: 128
  - Cisco: 255

- pingで得られるレスポンスのTTLの値は、パケットが経由したノードの数の分だけ減ったもの
- tracerouteでネットワーク経路上のノードを数えて、その分の数字を足せば、ホストが返すTTLの初期値が得られる
